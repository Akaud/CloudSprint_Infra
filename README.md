# CloudSprint Infrastructure - Terraform

## üèóÔ∏è Overview

This repository contains Terraform infrastructure code for the CloudSprint project - a Wagtail CMS deployment on AWS with modern cloud architecture.

## üéØ Architecture

### Infrastructure Components

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        AWS Infrastructure                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ   VPC & Network ‚îÇ  ‚îÇ   Compute Layer ‚îÇ  ‚îÇ   Data Layer    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ VPC           ‚îÇ  ‚îÇ ‚Ä¢ ECS Cluster   ‚îÇ  ‚îÇ ‚Ä¢ Aurora PG     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Private Subnet‚îÇ  ‚îÇ ‚Ä¢ ECS Service   ‚îÇ  ‚îÇ ‚Ä¢ RDS Proxy     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Public Subnet ‚îÇ  ‚îÇ ‚Ä¢ Task Def      ‚îÇ  ‚îÇ ‚Ä¢ Secrets Mgr   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Security Grps ‚îÇ  ‚îÇ ‚Ä¢ Security Grps ‚îÇ  ‚îÇ                 ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ   Storage Layer ‚îÇ  ‚îÇ   CDN & Edge    ‚îÇ  ‚îÇ   Container     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ S3 Static     ‚îÇ  ‚îÇ ‚Ä¢ CloudFront    ‚îÇ  ‚îÇ ‚Ä¢ ECR Repo      ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ S3 Media      ‚îÇ  ‚îÇ ‚Ä¢ OAI           ‚îÇ  ‚îÇ ‚Ä¢ Docker Images ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Lifecycle     ‚îÇ  ‚îÇ ‚Ä¢ Distribution  ‚îÇ  ‚îÇ                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Versioning    ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ                 ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Network Architecture

- **VPC**: `vpc-030d14759050848aa` (provided by team)
- **Region**: `eu-west-1` (Ireland)
- **Private Subnet**: `10.0.1.0/24` (for Aurora, ECS)
- **Public Subnet**: `10.0.2.0/24` (for ALB, future use)

## üìÅ Repository Structure

```
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ ci.yml          # CI pipeline (format, validate)
‚îÇ       ‚îú‚îÄ‚îÄ cd.yml          # CD pipeline (deploy to prod)
‚îÇ       ‚îî‚îÄ‚îÄ destroy.yml     # Infrastructure cleanup
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ vpc/               # VPC and subnet configuration
‚îÇ   ‚îú‚îÄ‚îÄ aurora_dsql/       # Aurora Serverless v2 PostgreSQL
‚îÇ   ‚îú‚îÄ‚îÄ ecs/               # ECS cluster and service
‚îÇ   ‚îú‚îÄ‚îÄ ecr/               # Docker image repository
‚îÇ   ‚îî‚îÄ‚îÄ s3/                # S3 buckets with CloudFront
‚îú‚îÄ‚îÄ environments/
‚îÇ   ‚îú‚îÄ‚îÄ dev/               # Development environment
‚îÇ   ‚îî‚îÄ‚îÄ prod/              # Production environment
‚îî‚îÄ‚îÄ README.md              # This documentation
```

## üß© Modules

### VPC Module (`modules/vpc/`)

**Purpose**: Network infrastructure using existing VPC

**Resources**:
- Data source for existing VPC
- Private subnet for Aurora and ECS
- Public subnet for future ALB

**Variables**:
- `ENV`: Environment name (dev/prod)
- `AWS_REGION`: AWS region

**Outputs**:
- `vpc_id`: VPC ID
- `private_subnet_ids`: List of private subnet IDs

### Aurora Module (`modules/aurora_dsql/`)

**Purpose**: PostgreSQL database with Aurora Serverless v2

**Resources**:
- Aurora PostgreSQL cluster
- RDS Proxy for connection pooling
- Security groups
- Secrets Manager for credentials
- IAM roles and policies

**Features**:
- Serverless v2 scaling (0.5 - 2.0 ACU)
- Auto-pause after 5 minutes of inactivity
- SSL/TLS encryption enabled by default
- Monitoring and performance insights

### ECS Module (`modules/ecs/`)

**Purpose**: Container orchestration for Wagtail CMS

**Resources**:
- ECS cluster
- ECS service
- Task definition
- Security groups
- IAM execution role

**Configuration**:
- Auto-scaling based on CPU/memory
- Health checks and load balancing
- Integration with ECR and Aurora

### S3 Module (`modules/s3/`)

**Purpose**: Object storage for static files and media

**Resources**:
- S3 buckets with versioning
- CloudFront distribution
- Origin Access Identity (OAI)
- Lifecycle policies
- Public access policies

**Buckets**:
- `wagtail-static-site-{env}`: Static website files
- `wagtail-media-{env}`: User uploads and media

### ECR Module (`modules/ecr/`)

**Purpose**: Docker image repository

**Resources**:
- ECR repository
- Image scanning
- Lifecycle policies

## üöÄ Getting Started

### Prerequisites

- **AWS CLI** configured with appropriate credentials
- **Terraform** >= 1.0
- **Git** for repository management

### AWS Profile Setup

```bash
# Configure AWS profile for MFA
aws configure --profile dev-mfa

# Set environment variables
export AWS_PROFILE=dev-mfa
export AWS_REGION=eu-west-1
```

### Local Development

```bash
# Clone repository
git clone https://github.com/Akaud/CloudSprint_Infra.git
cd CloudSprint_Infra/environments/dev

# Initialize Terraform
terraform init

# Plan changes
terraform plan

# Apply infrastructure
terraform apply
```

### Environment Variables

```bash
# Required environment variables
ENV=dev                    # Environment name
AWS_REGION=eu-west-1       # AWS region
AWS_PROFILE=dev-mfa        # AWS profile
```

## üîÑ CI/CD Pipeline

### GitHub Actions Workflows

#### CI Pipeline (`.github/workflows/ci.yml`)

**Triggers**: Pull requests, pushes to main/develop
**Actions**:
- Terraform format check
- Terraform validation
- Security scanning

#### CD Pipeline (`.github/workflows/cd.yml`)

**Triggers**: Push to release branch
**Actions**:
- AWS authentication via OIDC
- Terraform apply to production
- Infrastructure deployment

#### Destroy Pipeline (`.github/workflows/destroy.yml`)

**Purpose**: Cleanup infrastructure
**Use**: Manual trigger for cleanup

## üõ†Ô∏è Development Workflow

### 1. Create Feature Branch

```bash
git checkout -b feature/your-feature-name
```

### 2. Make Changes

- Modify Terraform modules
- Update environment configurations
- Test with `terraform plan`

### 3. Commit and Push

```bash
git add .
git commit -m "feat: Description of changes"
git push origin feature/your-feature-name
```

### 4. Create Pull Request

- Create PR on GitHub
- Wait for CI checks to pass
- Get code review approval
- Merge to develop/main

## üîß Common Commands

### Terraform Operations

```bash
# Initialize modules
terraform init

# Validate configuration
terraform validate

# Format code
terraform fmt

# Plan changes
terraform plan

# Apply changes
terraform apply

# Destroy infrastructure
terraform destroy
```

### State Management

```bash
# List resources
terraform state list

# Show resource details
terraform state show module.vpc.data.aws_vpc.existing

# Remove resource from state
terraform state rm module.resource_name
```

### Module Management

```bash
# Update modules
terraform get -update

# Reconfigure backend
terraform init -reconfigure
```

## üö® Troubleshooting

### Common Issues

#### VPC Limit Exceeded
```bash
# Check VPC count in region
aws ec2 describe-vpcs --region eu-west-1 --profile dev-mfa

# Use existing VPC instead of creating new one
```

#### SSL Parameter Errors
```bash
# Aurora PostgreSQL doesn't support custom SSL parameters
# SSL is enabled by default - remove custom parameters
```

#### Region Mismatch
```bash
# Ensure all resources use same region
# Check variables.tf and provider.tf
```

### Debug Commands

```bash
# Check AWS credentials
aws sts get-caller-identity --profile dev-mfa

# Verify VPC exists
aws ec2 describe-vpcs --vpc-ids vpc-030d14759050848aa

# Check subnet availability
aws ec2 describe-subnets --filters "Name=vpc-id,Values=vpc-030d14759050848aa"
```

## üìä Monitoring and Logging

### CloudWatch Metrics

- **ECS**: CPU, memory utilization, task count
- **Aurora**: Database connections, query performance
- **S3**: Request counts, error rates
- **CloudFront**: Cache hit rates, origin latency

### Logs

- **ECS**: Application logs via CloudWatch Logs
- **Aurora**: Database logs via CloudWatch Logs
- **CloudFront**: Access logs to S3

## üîí Security

### IAM Roles and Policies

- **ECS Task Execution Role**: Minimal permissions for container execution
- **RDS Proxy Role**: Secrets Manager access for database credentials
- **GitHub Actions Role**: OIDC-based authentication for CI/CD

### Network Security

- **Security Groups**: Restrict access to necessary ports only
- **VPC**: Private subnets for sensitive resources
- **CloudFront**: HTTPS-only access with modern TLS

### Data Protection

- **Encryption**: S3, Aurora, and EBS encryption at rest
- **Secrets**: Database credentials stored in Secrets Manager
- **Access Control**: Principle of least privilege

## üìà Scaling and Performance

### Auto-scaling

- **ECS**: CPU/memory-based scaling policies
- **Aurora**: Serverless v2 with 0.5-2.0 ACU range
- **S3**: Intelligent Tiering for cost optimization

### Performance Optimization

- **CloudFront**: Global CDN for static content
- **RDS Proxy**: Connection pooling for database
- **S3**: Lifecycle policies for storage optimization

## üí∞ Cost Optimization

### Resource Optimization

- **Aurora Serverless**: Pay only for used capacity
- **S3 Lifecycle**: Automatic transition to cheaper storage
- **ECS Spot**: Use spot instances for non-critical workloads

### Monitoring Costs

- **AWS Cost Explorer**: Track spending by service
- **Billing Alerts**: Set up cost thresholds
- **Resource Tagging**: Track costs by environment/project

## ü§ù Contributing

### Code Standards

- **Terraform**: Use consistent formatting (`terraform fmt`)
- **Variables**: Use descriptive names and add descriptions
- **Tags**: Tag all resources with Environment and Purpose
- **Documentation**: Update README for significant changes

### Review Process

1. **Code Review**: All changes require PR review
2. **Testing**: Test changes in dev environment first
3. **Validation**: Ensure `terraform validate` passes
4. **Documentation**: Update relevant documentation

## üìû Support

### Team Contacts

- **Infrastructure Team**: [Contact Info]
- **DevOps Lead**: [Contact Info]
- **Project Manager**: [Contact Info]

### Resources

- **AWS Documentation**: [AWS Docs]
- **Terraform Documentation**: [Terraform Docs]
- **Internal Wiki**: [Team Wiki]

## üìù Changelog

### [Unreleased]
- Initial infrastructure setup
- VPC module with existing VPC
- Aurora Serverless v2 configuration
- ECS cluster for Wagtail CMS
- S3 buckets with CloudFront CDN

### [v1.0.0] - 2025-01-XX
- Initial release
- Complete infrastructure stack
- CI/CD pipeline setup
- Documentation and guides

---

**Last Updated**: January 2025  
**Terraform Version**: >= 1.0  
**AWS Provider Version**: ~> 6.0